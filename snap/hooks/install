#!/bin/bash -eu

tag="snap.$SNAP_INSTANCE_NAME.hook.install"

# Redirect stdout to stdout+syslog
exec 1> >(tee >(logger --tag=$tag))
# Redirect stderr to stderr+syslog
exec 2> >(logger --stderr --priority error --tag=$tag)

# Clear the cached machine info
# This can exist even on a fresh install if the snap was previously installed
# and the system hasn't been rebooted ever since.
rm --force /tmp/machine-info.json

#
# Set generic configurations
#

deepseek-r1 set --package http.port="8324"
deepseek-r1 set --package http.host="127.0.0.1"
deepseek-r1 set --package verbose="false"

#
# Auto engine selection
#

if snapctl is-connected hardware-observe; then
  deepseek-r1 use-engine --auto --assume-yes
elif lscpu -V &>/dev/null; then
  echo "Able to access hardware info without hardware-observe interface connection: assuming dev mode installation."
  deepseek-r1 use-engine --auto --assume-yes
else
  echo "hardware-observe interface not auto connected. Skip auto engine selection."
fi
